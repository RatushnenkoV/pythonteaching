{% extends 'base.html' %}

{% block title %}Уроки - Python Trainer{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('teacher.lessons') }}">Классы</a></li>
        {% if selected_class %}
        <li class="breadcrumb-item">
            <a href="{{ url_for('teacher.lessons', class_id=selected_class.id) }}">{{ selected_class.name }}</a>
        </li>
        {% endif %}
        {% for bc in breadcrumbs %}
        <li class="breadcrumb-item">
            <a href="{{ url_for('teacher.lessons', topic_id=bc.id) }}">{{ bc.name }}</a>
        </li>
        {% endfor %}
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-folder2-open"></i>
        {% if parent %}
            {{ parent.name }}
        {% elif selected_class %}
            {{ selected_class.name }} - Темы
        {% else %}
            Выберите класс
        {% endif %}
    </h2>
    <div>
        {% if selected_class %}
        <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#createTopicModal">
            <i class="bi bi-folder-plus"></i> Новая тема
        </button>
        {% endif %}
        {% if parent %}
        <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#importLessonsModal">
            <i class="bi bi-upload"></i> Импорт
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createLessonModal">
            <i class="bi bi-plus-lg"></i> Новый урок
        </button>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Классы (если показываем классы) -->
    {% if view_mode == 'classes' and classes %}
    {% for class in classes %}
    <div class="col-md-4 mb-3">
        <div class="card h-100 folder-card">
            <div class="card-body d-flex align-items-center">
                <i class="bi bi-people-fill text-primary fs-2 me-3"></i>
                <div class="flex-grow-1">
                    <h6 class="card-title mb-0">{{ class.name }}</h6>
                    <small class="text-muted">{{ class.topics|length }} тем</small>
                </div>
            </div>
            <a href="{{ url_for('teacher.lessons', class_id=class.id) }}" class="stretched-link"></a>
        </div>
    </div>
    {% endfor %}
    {% endif %}

    <!-- Темы (папки) -->
    {% for topic in topics %}
    <div class="col-md-4 mb-3">
        <div class="card h-100 folder-card">
            <div class="card-body d-flex align-items-center">
                <i class="bi bi-folder-fill text-warning fs-2 me-3"></i>
                <div class="flex-grow-1">
                    <h6 class="card-title mb-0">{{ topic.name }}</h6>
                    <small class="text-muted">{{ topic.lessons|length }} уроков</small>
                </div>
                <div class="dropdown">
                    <button class="btn btn-link" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="{{ url_for('teacher.lessons', topic_id=topic.id) }}">
                                <i class="bi bi-folder2-open"></i> Открыть
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form method="POST" action="{{ url_for('teacher.delete_topic', topic_id=topic.id) }}"
                                  onsubmit="return confirm('Удалить тему {{ topic.name }}?');">
                                <button type="submit" class="dropdown-item text-danger">
                                    <i class="bi bi-trash"></i> Удалить
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
            <a href="{{ url_for('teacher.lessons', topic_id=topic.id) }}" class="stretched-link"></a>
        </div>
    </div>
    {% endfor %}

    <!-- Уроки -->
    {% for lesson in lessons %}
    <div class="col-md-4 mb-3">
        <div class="card h-100">
            <div class="card-body d-flex align-items-center">
                <i class="bi bi-file-earmark-text text-primary fs-2 me-3"></i>
                <div class="flex-grow-1">
                    <h6 class="card-title mb-0">{{ lesson.title }}</h6>
                    <small class="text-muted">{{ lesson.tasks|length }} заданий</small>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <a href="{{ url_for('teacher.lesson_edit', lesson_id=lesson.id) }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-pencil"></i> Редактировать
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if view_mode == 'classes' and not classes %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    У вас пока нет классов. <a href="{{ url_for('teacher.classes') }}">Создайте класс</a>, чтобы начать добавлять уроки.
</div>
{% elif view_mode == 'topics' and not topics and not lessons %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    {% if parent %}
        В этой теме пока нет уроков. Создайте первый урок!
    {% else %}
        В этом классе пока нет тем. Создайте первую тему!
    {% endif %}
</div>
{% endif %}

<!-- Modal: Создать тему -->
{% if selected_class %}
<div class="modal fade" id="createTopicModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('teacher.create_topic') }}">
                <input type="hidden" name="parent_id" value="{{ parent.id if parent else '' }}">
                <input type="hidden" name="class_id" value="{{ selected_class.id }}">
                <div class="modal-header">
                    <h5 class="modal-title">Создать тему</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="topicName" class="form-label">Название темы</label>
                        <input type="text" class="form-control" id="topicName" name="name"
                               placeholder="например: Циклы" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal: Создать урок -->
{% if parent %}
<div class="modal fade" id="createLessonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('teacher.create_lesson') }}">
                <input type="hidden" name="topic_id" value="{{ parent.id }}">
                <div class="modal-header">
                    <h5 class="modal-title">Создать урок</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="lessonTitle" class="form-label">Название урока</label>
                        <input type="text" class="form-control" id="lessonTitle" name="title"
                               placeholder="например: Цикл while" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Импорт уроков -->
<div class="modal fade" id="importLessonsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('teacher.import_lessons') }}" enctype="multipart/form-data">
                <input type="hidden" name="topic_id" value="{{ parent.id }}">
                <div class="modal-header">
                    <h5 class="modal-title">Импорт уроков</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="importFile" class="form-label">Файл JSON</label>
                        <input type="file" class="form-control" id="importFile" name="file" accept=".json" required>
                    </div>
                    <div class="alert alert-info mb-0">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            Используйте файл <code>lesson_import_template.json</code> в корне проекта как шаблон.
                            <br><br>
                            <strong>Структура файла:</strong>
                            <pre class="mb-0 mt-2" style="font-size: 11px;">{
  "lessons": [{
    "title": "Название урока",
    "tasks": [{
      "title": "Задание",
      "description": "&lt;p&gt;HTML&lt;/p&gt;",
      "tests": [{
        "input": "5",
        "output": "10",
        "hidden": false
      }]
    }]
  }]
}</pre>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Импортировать</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
